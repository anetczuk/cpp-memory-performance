#!/bin/bash

##
## This file is automatically generated from "@GENERATOR_FILE@". Changes will be lost.
##

set -eu

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"

cd $SCRIPT_DIR

SCRIPT_NAME=$(basename "$0")
SCRIPT_NAME=${SCRIPT_NAME%.*}


argv=$@

run_benchmark=1
while test $# != 0; do
    case "$1" in
	    --no-benchmark|-nb) run_benchmark=0 ;;
	    *)  ;;
    esac
    shift
done


cores_num=$(grep -c ^processor /proc/cpuinfo)

echo "Detected cores: ${cores_num}"


DATA_DIR="./data"

mkdir -p $DATA_DIR


benchmark_exec=./benchmark_@DATA_TYPE@
raw_file_prefix=$DATA_DIR/raw_data_@DATA_TYPE@_core
plot_file_prefix=$DATA_DIR/plot_data_@DATA_TYPE@_core


if [ $run_benchmark -ne 0 ]; then
	echo "Generating data"
	$benchmark_exec $argv
fi


## processing data
echo "Extracting data"
plot_data_files=""
for i in $(seq 1 $cores_num); do
    in_file=${raw_file_prefix}_${i}.txt
    data_file=${plot_file_prefix}_$i.txt
    awk -F" " '{print $1, $9, $3 $4}' $in_file > $data_file
    plot_data_files=$plot_data_files" "$data_file
done


plot_png="$DATA_DIR/${SCRIPT_NAME}.png"


echo "Plotting"
gnuplot -p -e '
			    set title "@PLOT_TITLE@"; 
			    filenames = "'"$plot_data_files"'";
			    output_png = "'"$plot_png"'"
			  ' plot_config_multi.gnu
